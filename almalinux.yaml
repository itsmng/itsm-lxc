---
image:
  distribution: almalinux
  release: 10

source:
  downloader: almalinux-http
  url: https://almalinux.savoirfairelinux.net
  keys:
    # RPM-GPG-KEY-AlmaLinux-10
    - |-
      -----BEGIN PGP PUBLIC KEY BLOCK-----
      
      mQINBGaP6O8BEACvg8IlAxGayV8zOi9Ex+Pd8lrj2BrBzloG8ri84ORp9o8ojq7l
      ykKmIElHe11cQD2Lf/a4lcQQ4Ec3baiD786X6K2eVSlBEAnZMzfjDg8R63SfsBuu
      8Yk+lUyqlBrDnSDYaPruOAzLIz2r82ikIC1jDbipZsMFPFHPI4/hayyWxJ3oGxRe
      0mbtYLB9ElEKngt+/hfo7JLklakbznyIRuVEF3VrZb91XC6r/idqfJoNyBXSKidj
      z0IwqOhgkLUk84rzltDo3AzwGqusd7PEuhOmqinOhp0hMdXsztD4TVyhw82iXu/O
      onOAObZTZYfM6Z8btmDqkoo0aT+oPPCuZ3yC/caU9dhvCSXET/CGoXc3hL55u9PV
      qmcVm/mwvuEImEAvxVc0/dBzEUk+FwW8KsaN3HoUKrC4/NqgmaQz8/42np7u2j+B
      OOJ4hAckNEdWd8rB86CYN00sdxnvLBsp8V3IwEqXLhGOoBsagy61Z8hKCM+siOGn
      xmbbybgaLOs+DPlxt9LrtgLJHODwmD96oysUPJuA0lv8KMiSpId0tSpp9Wn/wHBG
      kRgxGYfzQu7WRvRZqQaleft1JTXXOjNzPur0RkJyb3yFwAoxpePyo/WrupM41OHW
      58cEqdC6riCnJcS4U84RLj+hwvufBVB7areQ75sETnKeyozZW+P16E1t/wARAQAB
      tChBbG1hTGludXggT1MgMTAgPHBhY2thZ2VyQGFsbWFsaW51eC5vcmc+iQJMBBMB
      CgA2FiEE7m23uY9b9e3Z2g3l3uXBHMKh5XIFAmaP6O8CGwMECwkIBwQVCgkIBRYC
      AwEAAh4FAheAAAoJEN7lwRzCoeVy32AP/A2+KI+JhmsxnactSptkAWGyAAf1YBWW
      Js2sc9OJdKj7uIkzszCx7c7VIVeF/VLijIYpM/zwUgir5S5SimzQmY+FumwbKIml
      K5RBsoSog22i7Edho0MLa1pa6qvnKS0nkl9DEcu8EbMUhucWbxGnCG/22EEMTrY+
      Si1IZNkDGtlBHHBKMC+STbqqTxtdy4tAd2NYwWh3sBIh6PF7T4NLRAugu7PZQr5K
      amS4z2lV3ebshGjieA0Zoznwh0AXgN0gZ/0pC/LXI25gcgtrvkCyL8Fe0AyZUMd8
      UvZXaRSsm3SkCUIlGjPrvuItn1D7tHmqVSCDKXDM2TqjfiRm1JF+2OFCBNvGz19V
      LxWd/Gf+0qw0dtKxRMKzGh0mxXY40hjtmYZulrPxhG5itNDjStovgrevM1HBsXs9
      ikrkOGQ0pFcqizTn4ZKAmMozEMuIuV89Vof2bBCg7pHT1FmXVdAaYJxb6a7A/CgN
      qHjoh8AxBiGw/Q2NM4YJlUVhHqqd+/lUG3WJqACNEnqSlZkYQ3HqNNaKhHVbD4mN
      q/g6v+f8aWWDZDsI6IAfbJUB+KPEnIvQJQleWuHrq7kcUMhEq3dwBMIoTVEHhUUr
      RQKToSEM1rN7PcanaXQM2gy141dS7tFLxhapG8ug75LkIUnEOpPMtUjvrU1ZELGq
      36vVHBB+dTDg
      =tJCw
      -----END PGP PUBLIC KEY BLOCK-----
  variant: minimal

targets:
  lxc:
    create_message: |
      You just created a {{ image.description }} container.
    config:
      - type: all
        before: 5
        content: |-
          lxc.include = LXC_TEMPLATE_CONFIG/almalinux.common.conf

      - type: user
        before: 5
        content: |-
          lxc.include = LXC_TEMPLATE_CONFIG/almalinux.userns.conf

      - type: all
        after: 4
        content: |-
          lxc.include = LXC_TEMPLATE_CONFIG/common.conf

      - type: user
        after: 4
        content: |-
          lxc.include = LXC_TEMPLATE_CONFIG/userns.conf

      - type: all
        content: |-
          lxc.arch = {{ image.architecture_kernel }}

files:
  - name: hostname
    path: /etc/hostname
    generator: hostname

  - name: hosts
    path: /etc/hosts
    generator: hosts

  - path: /etc/machine-id
    generator: dump

  - path: /var/lib/dbus/machine-id
    generator: remove

  - name: ifcfg-eth0
    path: /etc/sysconfig/network-scripts/ifcfg-eth0
    generator: dump
    templated: true
    content: |-
      DEVICE=eth0
      BOOTPROTO=dhcp
      ONBOOT=yes
      HOSTNAME=LXC_NAME
      TYPE=Ethernet
      MTU=
      DHCP_HOSTNAME=LXC_NAME

  - name: ifcfg-eth0.incus
    path: /etc/sysconfig/network-scripts/ifcfg-eth0
    generator: template
    content: |-
      DEVICE=eth0
      BOOTPROTO=dhcp
      ONBOOT=yes
      HOSTNAME={{ container.name }}
      TYPE=Ethernet
      MTU=
      DHCP_HOSTNAME={{ container.name }}
      IPV6INIT=yes

  - name: 86-nm-unmanaged.rules
    path: /etc/udev/rules.d/86-nm-unmanaged.rules
    generator: dump
    content: |-
      ENV{ID_NET_DRIVER}=="veth", ENV{NM_UNMANAGED}="0"

  - name: network
    path: /etc/sysconfig/network
    generator: dump
    templated: true
    content: |-
      NETWORKING=yes
      HOSTNAME=LXC_NAME

  - name: network.incus
    path: /etc/sysconfig/network
    generator: template
    content: |-
      NETWORKING=yes
      HOSTNAME={{ container.name }}

packages:
  manager: yum
  update: true
  cleanup: true
  sets:
    - packages:
        - cronie
        - cronie-noanacron
        - curl
        - dhclient
        - glibc-langpack-en
        - glibc-locale-source
        - hostname
        - initscripts
        - openssh-clients
        - passwd
        - policycoreutils
        - rootfiles
        - rsyslog
        - sudo
        - vim-minimal
        - NetworkManager
        - newt
        - epel-release
      action: install

    - packages:
        - https://rpm.itsm-ng.org/redhat/9/itsm-ng-release-1.0-1.el9.noarch.rpm
      action: install

actions:
  - trigger: post-packages
    action: |-
      #!/bin/sh
      set -eux
      dnf install itsm-ng -y

      # Disable SELinux
      mkdir -p /selinux
      echo 0 > /selinux/enforce

      # Disable loginuid in PAM stack
      sed -i '/^session.*pam_loginuid.so/s/^session/# session/' /etc/pam.d/*

      # Set default locale
      localedef -i fr_FR -f UTF-8 fr_FR.UTF-8
      echo 'LANG=fr_FR.utf8' > /etc/locale.conf

      # Add setup-itsm script
      curl https://raw.githubusercontent.com/itsmng/itsm-lxc/main/setup-itsm \
      -o /usr/local/bin/setup-itsm
      chmod +x /usr/local/bin/setup-itsm

      # Add autorun
      echo "if [ ! -f /etc/itsm-ng/config_db.php ]; then setup-itsm; fi" \
        >> /root/.bashrc


  - trigger: post-files
    action: |-
      #!/bin/sh
      set -eux

      mkdir -p /etc/NetworkManager/conf.d/
      printf "[main]\ndhcp=dhclient" \
       > /etc/NetworkManager/conf.d/dhcp-client.conf

      systemctl enable NetworkManager.service httpd.service mariadb.service
